<html>
    <head>
        <title>Real Time Language Translation Agent System for Call Centers</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
         
    <link rel='canonical' href='https://www.csr13.me/pages/posts/live-speech-to-text-voice-translation.html' /> 
    
        <meta name='robots' content='index, follow'> 
        <meta name="description" content="My dump">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
     
    <link rel='canonical' href='https://www.csr13.me/pages/posts/live-speech-to-text-voice-translation.html' /> 
    
    <meta property='og:type' content='article' />
    <meta property='article:author' content='https://www.csr13.me' />
    <meta property='article:publisher' content='https://www.csr13.me' />
    <meta property='og:site_name' content='https://www.csr13.me' />
    <meta property='og:title' content='Real Time Language Translation Agent System for Call Centers' />
    <meta property='og:description' content='Real time language translation agent system for call centers.' />
    
    <meta property='og:url' content='https://www.csr13.me/pages/posts/live-speech-to-text-voice-translation.html' />

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="icon" type="image/x-icon" href="/static/images/favicon/favicon.ico"> 
        
    <link rel="stylesheet" href="/static/css/code-styles.css" />

        
    </head>
    <body>
        <header>
            <h2> <a style="text-decoration: none;"href="/">Notes</a></h2>
        </header>
        
    <div class="note">
        <div class="note-title">
            <h3>Real Time Language Translation Agent System for Call Centers</h3>
            <p>Date: 2023-11-16<br>By: csr13</p>
            <a 
                href="/media/documentation/pdfs/posts/live-speech-to-text-voice-translation.pdf" 
                target="_blank">
                <button> <small>Download as PDF </small></button>
            </a>
        </div>
        <div class="note-body">
            <p>Example use case. There is a call center that receives calls from foreign nationals
from all over the world, the call center does not have agents that speak 10
languages, how do you make it so that the operational cost of hiring call center
agents that speak 10 languages is not an budget killer?</p>
<p>On solution is to build a system for translating caller origin language to call center agent origin
language, and translating call center agent to caller origin language real time,
supporting multiple languages.</p>
<p>Building VOIP based systems without a need for something like asterisk can also be
built with Python and replacing software PBX systems like Asterisk with Twilio for
custom dialplans.</p>
<h3>Diagram and Schematics of the System.</h3>
<p>For example, the following schematics for this system, please excuse my design
skills.</p>
<div class="flex flex-column">
<img src="/static/images/posts/live-speech-to-text-diagram.png" width=400 height=400 />
</div>

<h3>Diagram Breakdown</h3>
<ul>
<li>1 Represents the caller, for this instance, the caller speaks chinese, and the agent speaks Arabic.</li>
<li>2 Represents the middle broker, Twilio which replaces any VOIP system like Asterisk,
so you don't have to program your own PBX.</li>
<li>3 Represents the first component of the system which is the relayer component, it's
purposes is to pass text converted from speech  and translate it from the callers origin language to the agents origin language, back
and forward.</li>
<li>4 Represents the web application backend the agent is using to type in messages in Arabic
and read messages from the caller in Arabic as well, because it was translated from Chinese to Arabic using AWS translation in component 3.</li>
<li>5 Is the agent from the call center, that is writing his/her responses in text, and
sending them from the web application (4) to the relayer (3) the relayer converts
text to the origin caller text, sends to middle broker (2) and finally the caller
get's the response in in his/her origin language.</li>
</ul>
<h3>Relayer Breakdown (Component 3)</h3>
<p>The relayer and the agent panel use <strong>redis</strong> as the message broker (in memory data storage), and the relayer
has a few tables to store call records, and transcripts of calls, which is very
important, the secret sauce.</p>
<p>Here are the only tables the relayer use, to store call information, and to store
messages from caller and agent, and generate transcript of calls.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Call</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">from_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Call language will be stored as </span>
    <span class="c1">#   &lt;full language&gt;|&lt;aws language code&gt;/&lt;twilio language code&gt;</span>
    <span class="n">call_language_code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">call_language_twilio_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_language_code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">twilio_code</span> <span class="o">=</span> <span class="n">codes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Language codes have not been set.&quot;</span>
        <span class="k">return</span> <span class="n">twilio_code</span>

    <span class="k">def</span> <span class="nf">call_language_aws_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_language_code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">aws_code</span> <span class="o">=</span> <span class="n">codes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Language codes have not been set.&quot;</span>
        <span class="k">return</span> <span class="n">aws_code</span>

    <span class="k">def</span> <span class="nf">call_language_natural</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_language_code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;language has not be set yet .. waiting&quot;</span>
        <span class="k">return</span> <span class="n">language</span>


<span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Call</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">from_agent</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">from_caller</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">,)</span>
</code></pre></div>

<p>Here is the main code for the relayer component API webhooks that
Twilio (the broker -- number 2 ) talks to and that the agent panel interacts with via
<strong>redis</strong>. I will break down the API endpoints in order, order is dicated by the dynamics of the
call.</p>
<p>First the system needs to know the language of the caller, so it prompts the caller
for it I will include all the imports only on this snippet, on the following ones I
won't.</p>
<p>The code is very readable, I added comments.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">twilio.twiml.voice_response</span> <span class="kn">import</span> <span class="n">Gather</span><span class="p">,</span> <span class="n">VoiceResponse</span>

<span class="kn">from</span> <span class="nn">.helpers</span> <span class="kn">import</span> <span class="n">translate_text</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Call</span><span class="p">,</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">.mappings</span> <span class="kn">import</span> <span class="n">LANGUAGE_MAPPINGS</span>
<span class="kn">from</span> <span class="nn">translator2.settings</span> <span class="kn">import</span> <span class="n">redis_connection</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1">#@require_POST</span>
<span class="nd">@csrf_exempt</span>
<span class="c1">#@validate_twilio_request</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entrypoint for the call center dialplan.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">########################################</span>
    <span class="c1"># Create the call in the entry point</span>
    <span class="c1">########################################</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CallSid&quot;</span><span class="p">)</span>
        <span class="n">from_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Caller&quot;</span><span class="p">)</span>
        <span class="n">country</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CallerCountry&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s2">&quot;CallSid&quot;</span><span class="p">]</span>
        <span class="n">from_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s2">&quot;Caller&quot;</span><span class="p">]</span>
        <span class="n">country</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s2">&quot;CallerCountry&quot;</span><span class="p">]</span>

    <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span>
        <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> 
        <span class="n">from_number</span><span class="o">=</span><span class="n">from_number</span><span class="p">,</span> 
        <span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">,</span>
        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">call</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">###############################################################</span>
    <span class="c1"># Generate response this should go to determine language view</span>
    <span class="c1">###############################################################</span>

    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Thanks for calling the call center &quot;</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Please say your native language in english&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
    <span class="n">gather</span> <span class="o">=</span> <span class="n">Gather</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;speech&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;/call/determine-language?rc=2&amp;rp=rt&#39;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gather</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="n">response</span><span class="p">,</span> 
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="nd">@require_POST</span>
<span class="nd">@csrf_exempt</span>
<span class="c1">#@validate_twilio_request</span>
<span class="k">def</span> <span class="nf">determine_language</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SpeechResult&quot;</span><span class="p">)</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">speech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">speech</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CallSid&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SID =&gt; </span><span class="si">%s</span><span class="s2"> is speaking in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">speech</span><span class="p">))</span>

    <span class="c1">#############################################################</span>
    <span class="c1"># Map languages to get the right one.</span>
    <span class="c1">#############################################################</span>

    <span class="n">call_language</span><span class="p">,</span> <span class="n">language_code</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">LANGUAGE_MAPPINGS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">speech</span><span class="p">:</span>
            <span class="n">call_language</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">language_code</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1">#################################################################</span>
    <span class="c1"># Handle no language mapped</span>
    <span class="c1">#################################################################</span>

    <span class="k">if</span> <span class="n">call_language</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Invalid language choice, language choices are: &quot;</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">LANGUAGE_MAPPINGS</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">each</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
        <span class="n">gather</span> <span class="o">=</span> <span class="n">Gather</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;speech&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;/call/determine-language?rc=2&amp;rp=rt&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gather</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gather</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1">#################################################################</span>
    <span class="c1"># Get the call and handle call not found.</span>
    <span class="c1">#################################################################</span>

    <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">voice</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
        <span class="n">voice</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s2">&quot;Call failed, please try again later.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">voice</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>

    <span class="c1">#################################################################</span>
    <span class="c1"># Store the language codes once they are obtained</span>
    <span class="c1">#################################################################</span>

    <span class="n">call</span><span class="o">.</span><span class="n">call_language_code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">call_language</span><span class="p">,</span> <span class="n">language_code</span><span class="p">)</span>
    <span class="n">call</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">#################################################################</span>
    <span class="c1"># Translate the default message and continue with the call </span>
    <span class="c1">#################################################################</span>

    <span class="c1"># Messages</span>
    <span class="n">welcome_message</span> <span class="o">=</span> <span class="s2">&quot;Your language has been set, please wait for 5 seconds&quot;</span>
    <span class="n">continue_message</span> <span class="o">=</span> <span class="s2">&quot;Thank you for waiting, an agent is available, you can talk now.&quot;</span>
    <span class="c1"># Translations</span>
    <span class="n">welcome_text</span> <span class="o">=</span> <span class="n">translate_text</span><span class="p">(</span><span class="n">welcome_message</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
    <span class="n">continue_text</span> <span class="o">=</span> <span class="n">translate_text</span><span class="p">(</span><span class="n">continue_message</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>

    <span class="c1">#####################################################################</span>
    <span class="c1"># Create response</span>
    <span class="c1">#####################################################################</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
    <span class="n">gather</span> <span class="o">=</span> <span class="n">Gather</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;speech&#39;</span><span class="p">,</span> 
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;/call/translate?rc=2&amp;rp=rt&#39;</span><span class="p">,</span> 
        <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_twilio_code</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">gather</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">welcome_text</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_twilio_code</span><span class="p">())</span>
    <span class="n">gather</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">gather</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">continue_text</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_twilio_code</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gather</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="n">response</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Content-Type&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>Next, this is the webhook to translate the message from the caller language, to the agents language, the webhooks url are hardcoded in the
<code>Gather(action=&lt;action&gt;, ...)</code>  action parameter of Gather object. One thing that
complicates the situation is if the agents takes more than 10 seconds to answer, the call dies,
this is solved by a 'duct tape hack' using the request session object, which allows
me to store if the agent reponded in time or not, and instead of ending the call on
error, this key is used as a boolean flag. This is possible due to the http protocol
nature, and it's considered, a 'hack' because twillio does not allow long waiting
sessions, so instead  direct twilio to forward the call to the same webhook if the
agent took long, and request session 'cookies' are used to store boolean value flags
to be utilized in the logic of the webhook.</p>
<p>Store last caller message with appended call sid and last agent response with call
sid like this</p>
<p><code>&lt;call-sid&gt;-latest-caller-message</code> and <code>&lt;call-sid&gt;-latest-agent-response</code> you might
encounter them in the snippets bellow.</p>
<p>Once a response for the latest caller message is obtained, then that interaction is
saved on the Messages table, related to a Call and the redis key is flushed, waiting
for the next interaction, and so on.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@require_POST</span>
<span class="nd">@csrf_exempt</span>
<span class="c1">#@validate_twilio_request</span>
<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">###################################################################</span>
    <span class="c1"># Check if the agent was able to respond in time and get the latest</span>
    <span class="c1"># speech.</span>
    <span class="c1">###################################################################</span>
    <span class="k">if</span> <span class="s1">&#39;agent_responded_in_time&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">agent_responded_in_time</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;agent_responded_in_time&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_responded_in_time</span><span class="p">:</span>
            <span class="n">speech</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caller_latest_text&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">speech</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SpeechResult&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">agent_responded_in_time</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">speech</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SpeechResult&quot;</span><span class="p">)</span>

    <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CallSid&quot;</span><span class="p">)</span>
    <span class="n">from_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Caller&quot;</span><span class="p">)</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CallerCountry&quot;</span><span class="p">)</span>

    <span class="c1">#######################################################</span>
    <span class="c1"># Get the call model</span>
    <span class="c1">#######################################################</span>

    <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span>
            <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> 
            <span class="n">from_number</span><span class="o">=</span><span class="n">from_number</span><span class="p">,</span> 
            <span class="n">country</span><span class="o">=</span><span class="n">country</span>
        <span class="p">)</span>
        <span class="n">call</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">##########################################################</span>
    <span class="c1"># Only translate if the agent was able to respond in time.</span>
    <span class="c1"># because the speech was already translated.</span>
    <span class="c1">##########################################################</span>

    <span class="n">redis</span> <span class="o">=</span> <span class="n">redis_connection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">redis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Redis connection established for sid session </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">agent_responded_in_time</span><span class="p">:</span>
        <span class="n">translate</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="n">service_name</span><span class="o">=</span><span class="s1">&#39;translate&#39;</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="s1">&#39;eu-west-1&#39;</span><span class="p">,</span> 
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">AWS_ACCESS_KEY_ID</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">AWS_SECRET_ACCESS_KEY</span>
        <span class="p">)</span>

        <span class="c1">#########################################################</span>
        <span class="c1"># Translate speech from the caller to arabic</span>
        <span class="c1">#########################################################</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Translating </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">speech</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">translate_text</span><span class="p">(</span>
            <span class="n">Text</span><span class="o">=</span><span class="n">speech</span><span class="p">,</span> 
            <span class="n">SourceLanguageCode</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_aws_code</span><span class="p">(),</span> 
            <span class="n">TargetLanguageCode</span><span class="o">=</span><span class="s2">&quot;en&quot;</span>
        <span class="p">)</span>
        <span class="n">outputText</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TranslatedText&#39;</span><span class="p">)</span>

        <span class="c1">########################################################################</span>
        <span class="c1"># Store the message from the caller for transcription.</span>
        <span class="c1">########################################################################</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
            <span class="n">call</span><span class="o">=</span><span class="n">call</span><span class="p">,</span> 
            <span class="n">speech</span><span class="o">=</span><span class="n">speech</span><span class="p">,</span> 
            <span class="n">translation</span><span class="o">=</span><span class="n">outputText</span><span class="p">,</span> 
            <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_aws_code</span><span class="p">(),</span>
            <span class="n">from_caller</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">from_agent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1">########################################################################</span>
        <span class="c1"># Set the latest message from the caller on this call for the agent</span>
        <span class="c1"># to read from cache.</span>
        <span class="c1">#########################################################################</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting last caller message for sid </span><span class="si">%s</span><span class="s2"> as =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">sid</span><span class="p">,</span> <span class="n">outputText</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-latest-caller-message&#39;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">,</span> <span class="n">outputText</span><span class="p">)</span>


    <span class="c1">#########################################################################</span>
    <span class="c1"># We are waiting for the agent to respond on other backend this is the</span>
    <span class="c1"># checkpoint for that.</span>
    <span class="c1">#########################################################################</span>

    <span class="n">agent_response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get the latest agent response for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-latest-agent-response&#39;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Latest agent response for sid </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#############################################################</span>
            <span class="c1"># Once we get the response, we need to set it back to empty.</span>
            <span class="c1">#############################################################</span>
            <span class="n">agent_response</span> <span class="o">=</span> <span class="n">response</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> got latest agent response =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
            <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-latest-agent-response&#39;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> waiting for agent response: seconds </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">sid</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span> 
                <span class="mi">11</span> <span class="o">-</span> <span class="n">i</span> 
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#########################################################################</span>
    <span class="c1"># Handle if the no agent picked up the phone call on their end, rude</span>
    <span class="c1">#########################################################################</span>

    <span class="k">if</span> <span class="n">agent_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> No response from the agent.&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
        <span class="n">response</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/call/translate?rc=2&amp;rp=rt&quot;</span><span class="p">)</span>
        <span class="n">http_response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span> 
            <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;agent_responded_in_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;caller_latest_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">speech</span>
        <span class="k">return</span> <span class="n">http_response</span>

    <span class="c1">############################################################################</span>
    <span class="c1"># Translate back to caller in caller&#39;s origin language</span>
    <span class="c1">############################################################################</span>

    <span class="c1"># Flush the request, because we did obtain, and we reset.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Flushing the request session&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">agent_response</span> <span class="o">=</span> <span class="n">agent_response</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">translate_text</span><span class="p">(</span><span class="n">agent_response</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;unable to translate&#39;</span>

    <span class="c1">###########################################################################</span>
    <span class="c1"># Create a new message, this time, the message comes from the agent, and it</span>
    <span class="c1"># needs to be translated to the callers language.</span>
    <span class="c1">###########################################################################</span>

    <span class="n">agent_message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
        <span class="n">call</span><span class="o">=</span><span class="n">call</span><span class="p">,</span> 
        <span class="n">speech</span><span class="o">=</span><span class="n">agent_response</span><span class="p">,</span> 
        <span class="n">translation</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> 
        <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_natural</span><span class="p">(),</span>
        <span class="n">from_caller</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">from_agent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">agent_message</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">#############################################################</span>
    <span class="c1"># Create the final response</span>
    <span class="c1">#############################################################</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
    <span class="n">gather</span> <span class="o">=</span> <span class="n">Gather</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;speech&#39;</span><span class="p">,</span> 
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;/call/translate?rc=2&amp;rp=rt&#39;</span><span class="p">,</span> 
        <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_twilio_code</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">gather</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">call_language_twilio_code</span><span class="p">())</span>
    <span class="n">gather</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gather</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="n">response</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>As you can see, the usage of redis is extensive, as it is the only way for the call
center agent panel to 'pick up calls' and read messages.</p>
<p>This last webhook is the error webhook, takes care of flagging the call as not
active, so call center agents are not able to see this call as active.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@require_POST</span>
<span class="nd">@csrf_exempt</span>
<span class="c1">#@validate_twilio_request</span>
<span class="k">def</span> <span class="nf">error_status</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This view should take care of cleanups</span>
<span class="sd">     - Modifying call statuses marking them as not active.</span>
<span class="sd">     - Other administrative tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">VoiceResponse</span><span class="p">()</span>
    <span class="n">response</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s2">&quot;Goodbye&quot;</span><span class="p">)</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CallSid&quot;</span><span class="p">)</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">call</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">call</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="n">response</span><span class="p">,</span> 
        <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/xml&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>So far, the relayer takes care of message translation and storing in memory (redis)
for the agent panel to be able to query, this message only if the call is active and
via redis storage.</p>
<h3>Agent Panel Logic</h3>
<p>The following API endpoints are from the agent panel, it has only a few endpoints,
needed to code a frontend capable of having call sessions via chat for available
calls, see transcripts, see active calls, and see inactive calls.</p>
<p>The main endpoints to look for are</p>
<ul>
<li>LatestCallerMessae</li>
<li>AnswerCallerMessage</li>
</ul>
<p>Self explanatory, but both of the use <strong>redis</strong> connection to read from the keys done
in step 3 component on the above part.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">api.serializers</span> <span class="kn">import</span> <span class="n">AnswerCallerSerializer</span>
<span class="kn">from</span> <span class="nn">config.settings</span> <span class="kn">import</span> <span class="n">redis_connection</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GetActiveCalls</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/call/calls?call-status=active&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">RELAYER_URL</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="s2">&quot;Unable to get active calls&quot;</span><span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">400</span>
            <span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">calls</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GetInactiveCalls</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/call/calls?call-status=inactive&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">RELAYER_URL</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="s2">&quot;Unable to get inactive calls&quot;</span><span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">400</span>
            <span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">calls</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LatestCallerMessage</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span>

        <span class="c1">##########################################################</span>
        <span class="c1"># Get the latest message, and clear it from the cache</span>
        <span class="c1">##########################################################</span>

        <span class="n">redis</span> <span class="o">=</span> <span class="n">redis_connection</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-latest-caller-message&#39;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;not-ready&quot;</span><span class="p">),</span> 
                <span class="n">status</span><span class="o">=</span><span class="mi">400</span>
            <span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-latest-caller-message&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AnswerCallerMessage</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">AnswerCallerSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">))</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>

        <span class="c1">##########################################################</span>
        <span class="c1"># Set the latest message, and ensure there is no message</span>
        <span class="c1"># set before doing so.</span>
        <span class="c1">##########################################################</span>

        <span class="n">redis</span> <span class="o">=</span> <span class="n">redis_connection</span><span class="p">()</span>
        <span class="n">temp_message</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-latest-agent-response&#39;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-latest-agent-response&#39;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">)</span>

        <span class="n">redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-latest-agent-response&quot;</span> <span class="o">%</span> <span class="n">sid</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-latest-caller-message&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Message sent ... waiting for response&quot;</span><span class="p">),</span>
            <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">GetCallDetails</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/call/messages/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">RELAYER_URL</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="s2">&quot;Unable to get call messages&quot;</span><span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">200</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>

<p>As far as frontend, I won't get into it, but the way it was done, is a simple
dashboard with login for agents, agents can pick up calls, have intervals of requests
made to these API endpoints every second (normal traffic in http) and when in a call,
having another interval to check for the latest caller message, and answering back
and forth, the agent sees the translated text from the caller on this chat window,
and answers in his language of origin, the relayer converts back to caller language.</p>
<p>If you are interested in VOIP custom call centers contact me, or
simple business call logic checks, like bank menus, or hotel menus, also contact me
for consulting and implementation.</p>
<p>As always the source code for this project is on my github, will add the link later
in the week.</p>
<p>Thanks for reading.</p>
        </div>
    </div>

        <footer>
            <div>
                <div>
                &copy; csr13 2023
                </div>
            </div>
        </footer>
        
        <script src="/static/js/main.js"></script>
    </body>
</html>