<html>
    <head>
        <title>Using ec2 instances as sneaker bid bots pt 2.</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="google-site-verification" content="2-n524qe11JQDqWEr-bTEf5zILWMTB27nmruGud5C1c" />
         
    <link rel='canonical' href='https://www.csr13.me/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-2.html' /> 
    
        <meta name='robots' content='index, follow'> 
        <meta name="description" content="My dump">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
     
    <link rel='canonical' href='https://www.csr13.me/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-2.html' /> 
    
    <meta property='og:type' content='article' />
    <meta property='article:author' content='https://www.csr13.me' />
    <meta property='article:publisher' content='https://www.csr13.me' />
    <meta property='og:site_name' content='https://www.csr13.me' />
    <meta property='og:title' content='Using ec2 instances as sneaker bid bots pt 2.' />
    <meta property='og:description' content='How to spawn AWS instances from django app to configure system bots to perform custom actions with predefined init scripts.' />
    
    <meta property='og:url' content='https://www.csr13.me/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-2.html' />

        <link rel="stylesheet" href="/static/css/normalize.css" />
        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="icon" type="image/x-icon" href="/static/images/favicon/favicon.ico"> 
        <link rel="stylesheet" href="/static/css/code-styles.css" />
        
    </head>
    <body>
        <div id="header"> </div>
<header>
    <nav>
        <a href="/"><img src="/static/images/images/biohazard3.png" height=50 width=50/></a>
    </nav>
</header>
<div class="side-piece-container">
    <div class="side-piece-up"><a href="#header">^</a></div>
    <div class="side-piece-down"><a href="#footer">v</a></div>
</div>
        <div class="main-div">
            
    <div class="note">
        <div class="note-title">
            <h3>Using ec2 instances as sneaker bid bots pt 2.</h3>
            <p>Date: 2023-11-27<br>By: csr13</p>
            <a 
                href="/media/documentation/pdfs/posts/using-ec2-instances-as-sneakers-bid-bots-pt-2.pdf" 
                target="_blank">
                <button> <small>Download as PDF </small></button>
            </a>
        </div>
        <div class="note-body">
            <p>Part two consists of the following:</p>
<ul>
<li>Creating the endpoints for biding and handling payment directly with Stripe.</li>
<li>Storing useful datas on the appropriate database tables, for which product this bid is on, size of the shoe, color, and other datas.</li>
<li>Creating the ec2/t2.micro instances raising them, obtaining their ip, and then putting them in an off state (so they don't generate expenses)</li>
</ul>
<p>First the frontend for any stripe integrated site will require an endpoint to fetch stripe public key -- to use on the frontend code, in order to verify account origins and esure that your stripe account is valid. Only then you can start processing
payments; if the fetched key is incorrect or outdated nothing will work.</p>
<p>API Endpoint for fetching public and for generating a checkout session for stripe payment</p>
<p>I will include imports only on this snippet -- added comments for readablity.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">stripe</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">aws.models</span> <span class="kn">import</span> <span class="n">UserAwsCheckoutResource</span>
<span class="kn">from</span> <span class="nn">bids.models</span> <span class="kn">import</span> <span class="n">ProductBid</span><span class="p">,</span> <span class="n">UserProductBid</span>
<span class="kn">from</span> <span class="nn">notifications.models</span> <span class="kn">import</span> <span class="n">UserNotification</span>
<span class="kn">from</span> <span class="nn">payments.exceptions</span> <span class="kn">import</span> <span class="n">InvalidBid</span>
<span class="kn">from</span> <span class="nn">users.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="c1"># ==============================================================</span>
<span class="c1"># Required for Checkout Service</span>
<span class="c1"># ==============================================================</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GetStripePublicKey</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stripePublicKey&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_PUBLIC_KEY</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CreateStripeCheckoutSession</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">SessionAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_checkout_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_bid</span><span class="p">:</span> <span class="n">ProductBid</span><span class="p">,</span> <span class="n">bid_total</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">ALLOWED_HOSTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:8000&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">ALLOWED_HOSTS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># ==================================================</span>
            <span class="c1"># Get the real bid total of the product bid.</span>
            <span class="c1"># =================================================</span>

            <span class="n">bid_total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bid_total</span><span class="p">)</span>
            <span class="n">product_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
            <span class="n">bid_only</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bid_total</span> <span class="o">-</span> <span class="n">product_price</span><span class="p">)</span>

            <span class="c1"># ===================================================</span>
            <span class="c1"># Handle bids that are not over the minimum threshold</span>
            <span class="c1"># ===================================================</span>

            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bid_only</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidBid</span><span class="p">(</span><span class="s2">&quot;Invalid bid placement.&quot;</span><span class="p">)</span>

            <span class="n">unit_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bid_only</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

            <span class="n">checkout_session</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">checkout</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_SECRET_KEY</span><span class="p">,</span>
                <span class="n">payment_method_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;card&quot;</span><span class="p">],</span>
                <span class="n">line_items</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;price_data&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;usd&quot;</span><span class="p">,</span>
                            <span class="c1"># Product bid amount includes bid fee</span>
                            <span class="c1"># via load bids command.</span>
                            <span class="s2">&quot;unit_amount&quot;</span><span class="p">:</span> <span class="n">unit_amount</span><span class="p">,</span>
                            <span class="s2">&quot;product_data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;unit_amount&quot;</span><span class="p">:</span> <span class="n">unit_amount</span><span class="p">,</span>
                    <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="n">product_bid</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">pk</span>
                <span class="p">},</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;payment&quot;</span><span class="p">,</span>
                <span class="n">success_url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/success-payment/</span><span class="si">{</span><span class="n">product_bid</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
                <span class="n">cancel_url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/bid/</span><span class="si">{</span><span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Unable to generate checkout session.&quot;</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">checkout_session</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bidId&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing pid&quot;</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bidTotal&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing bid amount&quot;</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="n">bid_total</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bidTotal&quot;</span><span class="p">)</span>
            <span class="n">product_bid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;bidId&quot;</span><span class="p">]</span>
            <span class="n">product_bid</span> <span class="o">=</span> <span class="n">ProductBid</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">product_bid</span><span class="p">)</span>
            <span class="n">release_date</span> <span class="o">=</span> <span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()[</span><span class="s2">&quot;releaseDate&quot;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">release_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)]</span>
            <span class="n">release_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="p">)</span>

            <span class="c1"># ===========================================</span>
            <span class="c1"># Handle a purchase past release date</span>
            <span class="c1"># ===========================================</span>

            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">release_date</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="s2">&quot;Bid closed&quot;</span>
                    <span class="p">)</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="n">checkout_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_checkout_session</span><span class="p">(</span>
                <span class="n">product_bid</span><span class="p">,</span> <span class="n">bid_total</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="p">)</span>

            <span class="c1"># ==============================================</span>
            <span class="c1"># Handle an error on generating checkout session</span>
            <span class="c1"># ==============================================</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">checkout_session</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>                
                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">ERROR_CODES</span><span class="p">[</span><span class="s2">&quot;002&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">checkout_session</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">ERROR_CODES</span><span class="p">[</span><span class="s2">&quot;001&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
</code></pre></div>

<p>For context I will add some database table models for ProductBid model, the name is self explanatory; this is for keeping track of bids made by certian users for certain products (Nike Sneakers)</p>
<p>Here are the models used on the checkout session for keeping track of things.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="kn">from</span> <span class="nn">sneakers.models</span> <span class="kn">import</span> <span class="n">Product</span>


<span class="k">class</span> <span class="nc">Bid</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">inital_fee</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProductBid</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">bid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Bid</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">active_bid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Product - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span> <span class="nc">UserProductBid</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
    <span class="p">)</span>
    <span class="n">product_bid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ProductBid</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">bid_amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&#39;s bid of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">get_product_bid_product_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">price</span>

    <span class="k">def</span> <span class="nf">get_product_bid_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid_amount</span>
</code></pre></div>

<p>Preety simple relational models, one model Bid, that handles the information for the bid made, which stores usefful things.</p>
<p><code>Bid</code></p>
<ul>
<li>Initial fee -- charged a default amount of 1.00 usd.</li>
<li>Bid Amount -- well the amount that was bid.</li>
<li>Start of the bid.</li>
<li>End of the bid.</li>
</ul>
<p><code>ProductBid</code></p>
<ul>
<li>A foreign key relation to a Bid object.</li>
<li>Product which the bid is taking pair with.</li>
<li>A boolean flag to know if the bid is active or not, for usage all around.</li>
</ul>
<p><code>UserProductBid</code></p>
<ul>
<li>User, the user that placed this product bid.</li>
<li>ProductBid, the product bid object is related here with the user.</li>
<li>Bid Amount that this used placed.</li>
<li>Timestamp of the bid.</li>
</ul>
<p>Here is the Product model, which is imported on the above module and is a key component of relationship making.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductImage</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-created_at&quot;</span><span class="p">]</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s2">&quot;Product Image&quot;</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Product Images&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s2">&quot;uploads/products/%Y/%m/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-created_at&quot;</span><span class="p">]</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s2">&quot;Product&quot;</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Products&quot;</span>

    <span class="n">brand</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">product_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">release_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">ProductImage</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;product_images&quot;</span><span class="p">)</span>
</code></pre></div>

<p>These models are self explanatory, same goes as the field names for the columns on this database table, posting them here to better explain what is happening.</p>
<p>The last part is the post payment action for creating the ec2/t2.micro instances that the user just paid for, in addition to the cost of the sneaker that the user placed a bid on, and all the fees for this service.</p>
<p>I took some time to comment the code, this is a refactored version of the tests done on part 1 of this series, this code is executed when Stripe process the payment, and the payment is a success, it triggers this listener webhook.</p>
<p>This code then handles the creation of the t2/ec2 instances for the bots to execute this job of trying to get the new Sneaker before it sells out, replicating parellel processes executing the same action, with more probabilities of getting one pair of sneakers.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SBListener</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>

        <span class="c1"># ====================================================</span>
        <span class="c1"># Get the signature header to authenticate that the</span>
        <span class="c1"># origin of this request is Stripe.</span>
        <span class="c1"># ===================================================</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sig_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">&quot;HTTP_STRIPE_SIGNATURE&quot;</span><span class="p">]</span>
            <span class="n">event</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Allowed&quot;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="c1"># ====================================================</span>
        <span class="c1"># Construct the stripe event to handle it accordingly</span>
        <span class="c1"># ====================================================</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">stripe</span><span class="o">.</span><span class="n">Webhook</span><span class="o">.</span><span class="n">construct_event</span><span class="p">(</span>
                <span class="n">payload</span><span class="p">,</span>
                <span class="n">sig_header</span><span class="p">,</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">STRIPE_WEBHOOK_SECRET</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)}</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">stripe</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SignatureVerificationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)}</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;checkout.session.completed&quot;</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

            <span class="c1"># =====================================================</span>
            <span class="c1"># Get all the things required to create bid record for</span>
            <span class="c1"># the customer on the db.</span>
            <span class="c1"># =====================================================</span>

            <span class="k">try</span><span class="p">:</span> 
                <span class="n">customer_email</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;customer_details&quot;</span><span class="p">][</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
                <span class="n">product_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;product_id&quot;</span><span class="p">]</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
                <span class="n">unit_amount</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;unit_amount&quot;</span><span class="p">]</span>
                <span class="n">product_bid</span> <span class="o">=</span> <span class="n">ProductBid</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">product_id</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">user_product_bid</span> <span class="o">=</span> <span class="n">UserProductBid</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">product_bid</span><span class="o">=</span><span class="n">product_bid</span><span class="p">,</span>
                    <span class="n">bid_amount</span><span class="o">=</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">unit_amount</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;006&quot;</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product_bid</span><span class="o">.</span><span class="n">product</span>

            <span class="n">bid_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">unit_amount</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="p">)</span>

            <span class="c1">############################################################################</span>
            <span class="c1"># We have a lower end limit of 25 usd per bid on bots of this action.</span>
            <span class="c1"># This means everybody must buy 25 or more usd on bots (ec2/t2) instances.</span>
            <span class="c1"># We don&#39;t take crypto only USD, fucking noobs, suck my dick.</span>
            <span class="c1">############################################################################</span>

            <span class="k">if</span> <span class="n">bid_amount</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>

                <span class="c1">############################################################################</span>
                <span class="c1"># Here on production it handles refund, this is actually handled on checkout.</span>
                <span class="c1"># So its rare it actually hits this condition.</span>
                <span class="c1">############################################################################</span>

                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

            <span class="n">number_of_instances</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bid_amount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1">###########################################</span>
            <span class="c1"># Unlikeley but we shall verify eitherway.</span>
            <span class="c1">###########################################</span>

            <span class="k">if</span> <span class="n">number_of_instances</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

            <span class="c1">###########################################</span>
            <span class="c1"># Create instances.</span>
            <span class="c1">###########################################</span>

            <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">create_instances</span><span class="p">(</span>
                <span class="n">ImageId</span><span class="o">=</span><span class="s2">&quot;ami-027ece036eecc0eea&quot;</span><span class="p">,</span>
                <span class="n">MaxCount</span><span class="o">=</span><span class="n">number_of_instances</span><span class="p">,</span> <span class="c1"># Using the number of instancers paid for.</span>
                <span class="n">MinCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">InstanceType</span><span class="o">=</span><span class="s2">&quot;t2.micro&quot;</span><span class="p">,</span>
                <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;ResourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;USER&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="n">KeyName</span><span class="o">=</span><span class="s2">&quot;puppeeter&quot;</span><span class="p">,</span>
                <span class="n">NetworkInterfaces</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;SubnetId&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">CHECKOUT_SUBNET_ID</span><span class="p">,</span>
                        <span class="s1">&#39;DeviceIndex&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;AssociatePublicIpAddress&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;Groups&#39;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">CHECKOUT_SECURITY_GROUP_ID</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="n">UserData</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">INIT</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span> <span class="c1"># Create the resource to keep track and fetch puiblic IP for command and control of this bot.</span>
                <span class="n">UserAwsCheckoutResource</span><span class="o">.</span><span class="n">cook_user_aws_checkout_resource</span><span class="p">(</span>
                    <span class="o">**</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                        <span class="n">instance_id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">public_ip</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                        <span class="n">product</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
                        <span class="n">meta</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1">#######################################################################################</span>
            <span class="c1"># This job is daemonized, meaning it runs in the background so it won&#39;t stall execution</span>
            <span class="c1"># Of this webhook</span>
            <span class="c1">########################################################################################</span>

            <span class="k">def</span> <span class="nf">step_one</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Make range dynamic in case a user buys 200+ proxies</span>
                <span class="k">while</span> <span class="n">iterator</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="n">current_instances</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
                        <span class="n">current_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">states_and_ids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">current_instances</span><span class="p">:</span>
                        <span class="n">states_and_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">each</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> 
                                <span class="n">each</span><span class="o">.</span><span class="n">id</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">states_and_ids</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="n">states_and_ids</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                        <span class="n">iterator</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>

                    <span class="c1"># =================================</span>
                    <span class="c1"># Stop the instances</span>
                    <span class="c1"># =================================</span>

                    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">current_instances</span><span class="p">:</span>
                        <span class="n">each</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

                    <span class="c1"># ================================</span>
                    <span class="c1"># Administrative tasks</span>
                    <span class="c1"># ================================</span>

                    <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">current_instances</span><span class="p">:</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ip</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">public_ip_address</span>
                            <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ip</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">ip</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">private_ip_address</span>
                                <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ip</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                    <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                            <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">user_instance</span> <span class="o">=</span> <span class="n">UserAwsCheckoutResource</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                <span class="n">instance_id</span><span class="o">=</span><span class="n">inst</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;No userawscheckoutresource </span><span class="si">{inst.id}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1"># =====================================</span>
                        <span class="c1"># Save the new state and the ip to the</span>
                        <span class="c1"># user instance resource</span>
                        <span class="c1"># =====================================</span>

                        <span class="n">user_instance</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">user_instance</span><span class="o">.</span><span class="n">public_ip</span> <span class="o">=</span> <span class="n">ip</span>
                        <span class="n">user_instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                    <span class="k">break</span>

            <span class="c1"># ===========================================</span>
            <span class="c1"># Start the job.</span>
            <span class="c1"># ===========================================</span>

            <span class="n">job</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">step_one</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">instances</span><span class="p">,</span>
                    <span class="n">user</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">UserNotification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">EVENT_TYPES</span><span class="p">[</span><span class="s2">&quot;RESOURCE_CREATED&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Proxy created for bid &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_product_bid</span><span class="o">.</span><span class="n">product_bid</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Bid placed&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid type&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div>

<p>Lastly, here is an example replica of how a task would be sent to any ec2/t2 instance running purchase on behalf of the user using static data. The public IP would be obtained from a  <code>UserAwsCheckoutResource</code> and replaced to be dynamically called. For
example, call this endpoint for each Checkout resource for a UserProductBid with the ProductBid and Product data as functional arguments, or in this case as request body data.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DemoCheckout</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAdmin</span><span class="p">,</span> <span class="n">IsCronjobRunner</span><span class="p">]</span>

    <span class="c1"># Place Holder datas, these are updated inside the endpoint.</span>
    <span class="n">address</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Carlota&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gorda&quot;</span><span class="p">,</span>
        <span class="s2">&quot;address_line_1&quot;</span><span class="p">:</span> <span class="s2">&quot;Km 20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;address_line_2&quot;</span><span class="p">:</span> <span class="s2">&quot; El Camino Real&quot;</span><span class="p">,</span>
        <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Encinitas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;90005&quot;</span><span class="p">,</span>
        <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;United States&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phone_number&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567891&quot;</span>
    <span class="p">}</span>

    <span class="n">task_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;site_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;https://www.nike.com/t/revolution-5-womens-running-shoe-wide-&quot;</span>
            <span class="s2">&quot;hC41Vf/BQ3207-111&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;billing_address_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;shipping_address_id&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is called via cron for each user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Here extract all task data and update the task data</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">preferred_address</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;billing&quot;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;billing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;address_line_1&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">billing_address_line_1</span><span class="p">,</span>
                <span class="s2">&quot;address_line_2&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">billing_address_line_2</span><span class="p">,</span>
                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">billing_city</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">billing_state</span><span class="p">,</span>
                <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">billing_postal_code</span><span class="p">,</span>
                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">billing_country</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;email_address&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="p">})</span>        

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;shipping&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shipping&quot;</span><span class="p">,</span>
                <span class="s2">&quot;address_line_1&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">shipping_address_line_1</span><span class="p">,</span>
                <span class="s2">&quot;address_line_2&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">shipping_address_line_2</span><span class="p">,</span>
                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">shipping_city</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">shipping_state</span><span class="p">,</span>
                <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">shipping_postal_code</span><span class="p">,</span>
                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">shipping_country</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;email_address&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="p">})</span>


        <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>

            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://34.228.52.8:8888/checkoutService/Addresses&quot;</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

            <span class="c1"># Your caller code should handle errors responses, for refund and complaints, to keep track of failures and errors.</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to create address&quot;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
                <span class="p">)</span>

            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://18.207.255.212/checkoutService/Tasks&quot;</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to create task&quot;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
                <span class="p">)</span>

            <span class="c1">##################################################</span>
            <span class="c1"># Card data is encrypted pre hitting a db commit.</span>
            <span class="c1">##################################################</span>

            <span class="n">final_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;card_friendly_name&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">card_friendly_name</span><span class="p">,</span>
                <span class="s2">&quot;cc_number&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">cc_number_enc</span><span class="p">,</span>
                <span class="s2">&quot;cc_expiry&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">cc_expiry_enc</span><span class="p">,</span>
                <span class="s2">&quot;cc_code&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">cc_code_enc</span><span class="p">,</span>
            <span class="p">}</span>

<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Final data looks like this, cc data is encrypted before even saving it, because PCI compliance requires it, otherwise, an audit can go wrong.</span>
<span class="sd">            final_data = {</span>
<span class="sd">                &quot;card_friendly_name&quot;: &quot;Mastercard&quot;,</span>
<span class="sd">                &quot;cc_number&quot;: &quot;gAAAAABgkKDt-7o6p8CvPYGKYxV3fOa2zE5jqx0h0lAEZ8f0oyOKe38qs7E8LuROn0MVicOMLNiimY6JEmu_-YqoA-xonwCIeaJ9OAIdsgcRcrrTBkORMEE=&quot;,</span>
<span class="sd">                &quot;cc_expiry&quot;: &quot;gAAAAABgkKE8q84txUVTYW9TVG1P0Yrkjfhrn5ggnb_YRarmdHJhJEB_K_wFMkMUGvyr9uesWpSxCT3HaA7ii224DjOHq5OdgQ==&quot;,</span>
<span class="sd">                &quot;cc_code&quot;: &quot;gAAAAABgkKG_PT4L5mw7Kbm1ULUZ3M3iqmCjqly_d5bky486vwo3uNdJdaPLQN435x1OIUvT0NPI7OVkUeYjrrCJCLPVfnffIA==&quot;</span>
<span class="sd">            }</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://18.207.255.212/checkoutService/Tasks/1/start?id=1&quot;</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">final_data</span><span class="p">)</span>

            <span class="c1">############################################################################</span>
            <span class="c1"># Same here, caller code should handle these errors for refunds and track of</span>
            <span class="c1"># Failures.</span>
            <span class="c1">#############################################################################</span>

            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to start task&quot;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;address_created&quot;</span>
                <span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
            <span class="p">)</span>
</code></pre></div>

<p>For clarity here is <code>UserAwsCheckoutResource</code> code -- it has some methods that are rareley used but I still left them there.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">ast</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ObjectDoesNotExist</span>

<span class="kn">from</span> <span class="nn">sneakers.models</span> <span class="kn">import</span> <span class="n">Product</span>


<span class="k">class</span> <span class="nc">UserAwsCheckoutResource</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">instance_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">public_ip</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">cook_user_aws_checkout_resource</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instance_id</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">ObjectDoesNotExist</span><span class="p">):</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resource</span>

    <span class="k">def</span> <span class="nf">get_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_instance_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">EC2_RESOURCE</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span><span class="o">.</span><span class="n">state</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">EC2_RESOURCE</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_boot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">EC2_RESOURCE</span><span class="o">.</span><span class="n">Instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>Part two includes key components of the program, it does not make sense for me to post entire solutions because I am just being nice here and providing a "more than what you see on the web how tos", because we made money out of this already around -- 2 years ago.</p>
<p>If you want full solution or custom one, contact me directly, but bring a good budget.</p>
<p>For part three I will write about how to secure users credit card information in order to comply with PCI standards, how to store your key to encrypt users credit cards as secure as possible. In addition I am going to write about how to scrape nike products, since nike.com uses React and Nike uses a local
store "storage" which often wont allow scrappers to scrape, because it dinamically loads, and selenium usage because of bot detection frontend libraries, will fuck you up.However, React is shit, and there's lots of flaws, and this makes it okay way to scrape React sites if you know how to get local storage store object and just traverse the 'store;.</p>
        </div>
    </div>
    
    <div class="series-list">
        <h3> This post is part of a series, check out the other parts of this series of notes </h3>
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
                <div class="post-list-item">
                    <p>
                        <a href='/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-3.html'> Using ec2 instances as sneaker bid bots pt 3. </a>
                    </a>
                </div>
            
        
            
        
            
        
            
                <div class="post-list-item">
                    <p>
                        <a href='/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-1.html'> Using ec2 instances as sneaker bid bots pt 1. </a>
                    </a>
                </div>
            
        
    
    <div class="note related-posts">
        <h3> Related Notes </h3>
        
    
    
    
        
            
        
            
        
            
                
                
            
        
            
        
    
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
                
                
            
        
            
        
            
        
            
        
    
        
            
                
                
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
                
                
            
        
    
        
            
                
                
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
    
        
            
                
                
            
        
            
        
            
        
            
        
    
    <div class="related-posts-list">
    
    
        
        <div class="post-list-item">
            <p><a href='/pages/posts/live-speech-to-text-voice-translation.html'>1) Real Time Language Translation Agent System for Call Centers</a></p>
            <p><small>Date published: 2023-11-16 </small></p>
            <p>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/voip/list.html">voip</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/telephony/list.html">telephony</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/python/list.html">python</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/systems/list.html">systems</a>
                    </span>
                </small>
                
            </p>
        </div>
    
        
        <div class="post-list-item">
            <p><a href='/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-2.html'>2) Using ec2 instances as sneaker bid bots pt 2.</a></p>
            <p><small>Date published: 2023-11-27 </small></p>
            <p>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/bots/list.html">bots</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/python/list.html">python</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/aws/list.html">aws</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/series/list.html">series</a>
                    </span>
                </small>
                
            </p>
        </div>
    
        
        <div class="post-list-item">
            <p><a href='/pages/posts/whatsapp-chatbot-python.html'>3) Whatsapp chatbot with Python and Twilio</a></p>
            <p><small>Date published: 2023-11-15 </small></p>
            <p>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/bots/list.html">bots</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/python/list.html">python</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/whatsapp/list.html">whatsapp</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/business/list.html">business</a>
                    </span>
                </small>
                
            </p>
        </div>
    
        
        <div class="post-list-item">
            <p><a href='/pages/posts/backend-task-manager-visual.html'>4) Backend Celery task manager dashboard via Flower</a></p>
            <p><small>Date published: 2023-10-29 </small></p>
            <p>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/backend/list.html">backend</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/tasks/list.html">tasks</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/python/list.html">python</a>
                    </span>
                </small>
                
            </p>
        </div>
    
        
        <div class="post-list-item">
            <p><a href='/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-3.html'>5) Using ec2 instances as sneaker bid bots pt 3.</a></p>
            <p><small>Date published: 2023-11-28 </small></p>
            <p>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/bots/list.html">bots</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/python/list.html">python</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/aws/list.html">aws</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/series/list.html">series</a>
                    </span>
                </small>
                
            </p>
        </div>
    
        
        <div class="post-list-item">
            <p><a href='/pages/posts/using-ec2-instances-as-sneakers-bid-bots-pt-1.html'>6) Using ec2 instances as sneaker bid bots pt 1.</a></p>
            <p><small>Date published: 2023-11-21 </small></p>
            <p>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/bots/list.html">bots</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/python/list.html">python</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/aws/list.html">aws</a>
                    </span>
                </small>
                
                <small>
                    <span class="category-span">
                        <a href="/pages/posts/categories/series/list.html">series</a>
                    </span>
                </small>
                
            </p>
        </div>
    
    </div>

    </div>

    </div>

        </div>
        <footer id="footer">
            <div>
                <div>
                &copy; csr13 2023
                </div>
            </div>
        </footer>
        
        <script src="/static/js/main.js"></script>
    </body>
</html>