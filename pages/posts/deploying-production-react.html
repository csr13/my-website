<html>
    <head>
        <title>Deploying production React app.</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="My dump">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/static/css/main.css" />
        
    <link rel="stylesheet" href="/static/css/code-styles.css" />

        
    </head>
    <body>
        <header>
            <h2> <a style="text-decoration: none;"href="/">Notes</a></h2>
        </header>
        
    <div class="note">
        <div class="note-title">
            <h3>Deploying production React app.</h3>
            <p>Date: 2023-11-10<br>By: csr13</p>
        </div>
        <div class="note-body">
            <p>React is entrypoint for entry level frontend developers, it's a popular framework.</p>
<p>So, is time to deploy production. You ask frontend team
(always arrogant) lead: why deploy instructions dictate only how to run react
development build? Where production instructions?</p>
<p>But when I deploy and see a source tree map of the entire
application on the browser development settings, with all the
source code for the frontend.</p>
<p>Ask frontend for solution to do this, they say "not sure".</p>
<p>When deploying for production react apps, react is nice
enough to let you compile the app in a single build/
directory. For not generating source map, a small but <em>very</em>
important step.</p>
<p>Dockerfile for nginx/frontend</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#syntax=docker/dockerfile:1</span>
<span class="n">FROM</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span><span class="n">frontend</span>
<span class="n">WORKDIR</span><span class="w"> </span><span class="o">/</span><span class="n">frontend</span>
<span class="n">COPY</span><span class="w"> </span><span class="n">frontend</span><span class="w"> </span><span class="o">.</span>
<span class="n">RUN</span><span class="w"> </span><span class="n">yarn</span><span class="w"> </span><span class="n">install</span>
<span class="n">RUN</span><span class="w"> </span><span class="n">GENERATE_SOURCEMAP</span><span class="o">=</span><span class="bp">false</span><span class="w"> </span><span class="n">npm</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">build</span>

<span class="n">FROM</span><span class="w"> </span><span class="n">nginx</span>

<span class="n">RUN</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rfvd</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>\
<span class="w">    </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="k">static</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>\
<span class="w">    </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>\
<span class="w">    </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>

<span class="n">COPY</span><span class="w"> </span><span class="o">--</span><span class="n">from</span><span class="o">=</span><span class="n">frontend</span><span class="w"> </span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">build</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>
<span class="n">COPY</span><span class="w"> </span><span class="o">./</span><span class="n">docker</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">conf</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">conf</span>
</code></pre></div>

<p>The main thing to look at is the RUN step for npm run build;
passing environment variable behind it,
GENERATE_SOURCEMAP=false does the trick. Multi-stage builds used
on the Dockerfile, check docker best practices for advices.</p>
<p>Seems like small step, but makes big difference; see figure
1.2 below</p>
<p>No source map tree on production builds, sysadmin can rest
better.</p>
<div style="width: auto; overflow: auto;">
<figure style="margin: 0;">
<img src="/static/images/images/step-one.png">
<figcaption>Figure 1.1</figcaption>
</figure>
<br>
<figure style="margin: 0;">
<img width=auto src="/static/images/images/step-two.png">
<figcaption>Figure 1.2</figcaption>
</figure>
</div>
<p>Last thing to do is modify nginx config file so that it can
search for that directory, which was copied to /var/www/html
inside nginx container (see nginx build stage on Dockerfile)</p>
<div class="codehilite"><pre><span></span><code><span class="n">upstream</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="n">api</span><span class="p">:</span><span class="mi">6969</span><span class="w"> </span><span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="o">...</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">...</span>
<span class="w">        </span><span class="o">...</span>
<span class="w">        </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">backend</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
        </div>
    </div>

        
        <script src="/static/js/main.js"></script>
    </body>
</html>